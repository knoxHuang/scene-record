'use strict';
const { readFileSync } = require('fs');
const { join, basename, extname } = require('path');
const STYLE = `<style>${readFileSync(join(__dirname, '../../statics/element/style.css'), 'utf8')}</style>`;
let HTML = `${readFileSync(join(__dirname, '../../statics/element/panel.html'), 'utf8')}`;
let onSceneReady;
let onAssetDbReady;
let onAssetChange;
class SceneHistroy extends HTMLElement {
    constructor() {
        super();
        this._list = new Map();
        this._noChange = false;
        this._init = false;
        this.attachShadow({
            mode: 'open'
        });
        if (!this.shadowRoot) {
            return;
        }
        HTML = HTML.replace(/\{\{t\(\'(\S+)\'\)\}\}/g, (str, subStr) => {
            return Editor.I18n.t(`scene-record.${subStr}`);
        });
        this.shadowRoot.innerHTML = `${STYLE}${HTML}`;
        this.$content = this.shadowRoot.querySelector('.content');
    }
    async addItem(uuid) {
        let url = await Editor.Message.request('asset-db', 'query-url', uuid);
        if (!url) {
            console.log(`Can't get the url by ${uuid}`);
            return;
        }
        const div = document.createElement('div');
        div.className = 'item';
        // @ts-ignore
        div.uuid = uuid;
        const icon = document.createElement('ui-icon');
        div.appendChild(icon);
        if (url.endsWith('.scene')) {
            icon.value = 'scene';
        }
        else if (url.endsWith('.prefab')) {
            icon.value = 'prefab';
        }
        icon.setAttribute('color', '#f0ad4e');
        const label = document.createElement('ui-label');
        label.value = basename(url);
        div.appendChild(label);
        const icon_del = document.createElement('ui-icon');
        icon_del.setAttribute('value', 'del');
        icon_del.className = 'del';
        div.appendChild(icon_del);
        if (this.$content) {
            this.$content.insertBefore(div, this.$content.firstChild);
        }
        icon_del.addEventListener('click', this._onDel.bind(this, div));
        div.addEventListener('mousedown', this._onMouseDown.bind(this));
        this._list.set(uuid, label);
        return div;
    }
    async onSceneReady(uuid) {
        if (this._noChange) {
            this._noChange = false;
            return;
        }
        let list = await Editor.Profile.getConfig('scene-record', 'list') || [];
        const index = list.indexOf(uuid);
        if (index !== -1) {
            list.splice(index, 1);
            const label = this._list.get(uuid);
            if (this.$content && label && label.parentElement) {
                this.$content.removeChild(label.parentElement);
            }
        }
        list.push(uuid);
        const item = await this.addItem(uuid);
        await Editor.Profile.setConfig('scene-record', 'list', list);
        this.changeState(item);
        this.parentElement.scrollTop = 0;
    }
    async onAssetChange(uuid) {
        let item = this._list.get(uuid);
        if (item) {
            let url = await Editor.Message.request('asset-db', 'query-url', uuid);
            item.value = basename(url);
        }
    }
    async onAssetDbReady() {
        await this.updateList();
    }
    async connectedCallback() {
        await this.updateList();
        onSceneReady = this.onSceneReady.bind(this);
        Editor.Message.addBroadcastListener(`scene:ready`, onSceneReady);
        onAssetDbReady = this.onAssetDbReady.bind(this);
        Editor.Message.addBroadcastListener('asset-db:ready', onAssetDbReady);
        onAssetChange = this.onAssetChange.bind(this);
        Editor.Message.addBroadcastListener('asset-db:asset-change', onAssetChange);
    }
    disconnectedCallback() {
        Editor.Message.removeBroadcastListener(`scene:ready`, onSceneReady);
        Editor.Message.removeBroadcastListener(`scene:ready`, onAssetDbReady);
        Editor.Message.removeBroadcastListener('asset-db:asset-change', onAssetChange);
    }
    async _onDel(div, event) {
        if (this.$content) {
            this.$content.removeChild(div);
            // @ts-ignore
            const uuid = div.uuid;
            this._list.delete(uuid);
            let list = await Editor.Profile.getConfig('scene-record', 'list') || [];
            const index = list.indexOf(uuid);
            if (index !== -1) {
                list.splice(index, 1);
            }
            await Editor.Profile.setConfig('scene-record', 'list', list);
        }
    }
    _onMouseDown(event) {
        // @ts-ignore
        if (event.target.className === 'del') {
            return;
        }
        // @ts-ignore
        let div = event.target.className === 'item' ? event.target : event.target.parentElement;
        div.classList.toggle('press');
        const mouseUp = async () => {
            this._noChange = true;
            // @ts-ignore
            await Editor.Message.send('scene', 'open-scene', div.uuid);
            div.classList.toggle('press');
            document.removeEventListener('mouseup', mouseUp, true);
            this.changeState(div);
        };
        document.addEventListener('mouseup', mouseUp, true);
    }
    async updateList() {
        if (this._init) {
            return;
        }
        this._init = true;
        const list = await Editor.Profile.getConfig('scene-record', 'list') || [];
        for (let uuid of list) {
            await this.addItem(uuid);
        }
    }
    changeState(div) {
        if (this._lastTarget) {
            this._lastTarget.classList.toggle('select');
        }
        div.classList.toggle('select');
        this._lastTarget = div;
    }
}
module.exports = SceneHistroy;
window.customElements.define('scene-record-list', SceneHistroy);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NlbmUtcmVjb3JkLWxpc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zb3VyY2UvZWxlbWVudC9zY2VuZS1yZWNvcmQtbGlzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7QUFJYixNQUFNLEVBQUUsWUFBWSxFQUFFLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3ZDLE1BQU0sRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUVwRCxNQUFNLEtBQUssR0FBRyxVQUFVLFlBQVksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLGlDQUFpQyxDQUFDLEVBQUUsTUFBTSxDQUFDLFVBQVUsQ0FBQztBQUMzRyxJQUFJLElBQUksR0FBRyxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLGtDQUFrQyxDQUFDLEVBQUUsTUFBTSxDQUFDLEVBQUUsQ0FBQztBQUUxRixJQUFJLFlBQWlCLENBQUM7QUFDdEIsSUFBSSxjQUFtQixDQUFDO0FBQ3hCLElBQUksYUFBa0IsQ0FBQztBQUN2QixNQUFNLFlBQWEsU0FBUSxXQUFXO0lBU2xDO1FBQ0ksS0FBSyxFQUFFLENBQUM7UUFOWixVQUFLLEdBQTZCLElBQUksR0FBRyxFQUFFLENBQUM7UUFFNUMsY0FBUyxHQUFHLEtBQUssQ0FBQztRQUNsQixVQUFLLEdBQUcsS0FBSyxDQUFDO1FBSVYsSUFBSSxDQUFDLFlBQVksQ0FBQztZQUNkLElBQUksRUFBRSxNQUFNO1NBQ2YsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDbEIsT0FBTztTQUNWO1FBQ0QsSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMseUJBQXlCLEVBQUUsQ0FBQyxHQUFHLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDM0QsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMs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LG1CQUFtQixDQUFDLFNBQVMsRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDdkQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMxQixDQUFDLENBQUM7UUFDRixRQUFRLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztJQUN4RCxDQUFDO0lBRUQsS0FBSyxDQUFDLFVBQVU7UUFDWixJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDWixPQUFPO1NBQ1Y7UUFDRCxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztRQUNsQixNQUFNLElBQUksR0FBRyxNQUFNLE1BQU0sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLGNBQWMsRUFBRSxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDMUUsS0FBSyxJQUFJLElBQUksSUFBSSxJQUFJLEVBQUU7WUFDbkIsTUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQzVCO0lBQ0wsQ0FBQztJQUVELFdBQVcsQ0FBQyxHQUFnQjtRQUN4QixJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDbEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQy9DO1FBQ0QsR0FBRyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDL0IsSUFBSSxDQUFDLFdBQVcsR0FBRyxHQUFHLENBQUM7SUFDM0IsQ0FBQztDQUNKO0FBRUQsTUFBTSxDQUFDLE9BQU8sR0FBRyxZQUFZLENBQUM7QUFFOUIsTUFBTSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsbUJBQW1CLEVBQUUsWUFBWSxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmRlY2xhcmUgY29uc3QgRWRpdG9yOiBhbnk7XG5cbmNvbnN0IHsgcmVhZEZpbGVTeW5jIH0gPSByZXF1aXJlKCdmcycpO1xuY29uc3QgeyBqb2luLCBiYXNlbmFtZSwgZXh0bmFtZSB9ID0gcmVxdWlyZSgncGF0aCcpO1xuXG5jb25zdCBTVFlMRSA9IGA8c3R5bGU+JHtyZWFkRmlsZVN5bmMoam9pbihfX2Rpcm5hbWUsICcuLi8uLi9zdGF0aWNzL2VsZW1lbnQvc3R5bGUuY3NzJyksICd1dGY4Jyl9PC9zdHlsZT5gO1xubGV0IEhUTUwgPSBgJHtyZWFkRmlsZVN5bmMoam9pbihfX2Rpcm5hbWUsICcuLi8uLi9zdGF0aWNzL2VsZW1lbnQvcGFuZWwuaHRtbCcpLCAndXRmOCcpfWA7XG5cbmxldCBvblNjZW5lUmVhZHk6IGFueTtcbmxldCBvbkFzc2V0RGJSZWFkeTogYW55O1xubGV0IG9uQXNzZXRDaGFuZ2U6IGFueTtcbmNsYXNzIFNjZW5lSGlzdHJveSBleHRlbmRzIEhUTUxFbGVtZW50IHtcblxuICAgICRjb250ZW50OiBIVE1MRWxlbWVudCB8IHVuZGVmaW5lZDtcblxuICAgIF9saXN0OiBNYXA8c3RyaW5nLCBIVE1MRWxlbWVudD4gPSBuZXcgTWFwKCk7XG4gICAgX2xhc3RUYXJnZXQ6IEhUTUxFbGVtZW50IHwgdW5kZWZpbmVkO1xuICAgIF9ub0NoYW5nZSA9IGZhbHNlO1xuICAgIF9pbml0ID0gZmFsc2U7XG5cbiAgICBjb25zdHJ1Y3RvciAoKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMuYXR0YWNoU2hhZG93KHtcbiAgICAgICAgICAgIG1vZGU6ICdvcGVuJ1xuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoIXRoaXMuc2hhZG93Um9vdCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIEhUTUwgPSBIVE1MLnJlcGxhY2UoL1xce1xce3RcXChcXCcoXFxTKylcXCdcXClcXH1cXH0vZywgKHN0ciwgc3ViU3RyKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gRWRpdG9yLkkxOG4udChgc2NlbmUtcmVjb3JkLiR7c3ViU3RyfWApO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5zaGFkb3dSb290LmlubmVySFRNTCA9IGAke1NUWUxFfSR7SFRNTH1gO1xuICAgICAgICB0aGlzLiRjb250ZW50ID0gdGhpcy5zaGFkb3dSb290LnF1ZXJ5U2VsZWN0b3IoJy5jb250ZW50JykgYXMgSFRNTEVsZW1lbnQ7XG4gICAgfVxuXG4gICAgYXN5bmMgYWRkSXRlbSAodXVpZDogc3RyaW5nKSB7XG4gICAgICAgIGxldCB1cmwgPSBhd2FpdCBFZGl0b3IuTWVzc2FnZS5yZXF1ZXN0KCdhc3NldC1kYicsICdxdWVyeS11cmwnLCB1dWlkKTtcbiAgICAgICAgaWYgKCF1cmwpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBDYW4ndCBnZXQgdGhlIHVybCBieSAke3V1aWR9YCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgZGl2OiBIVE1MRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICBkaXYuY2xhc3NOYW1lID0gJ2l0ZW0nO1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGRpdi51dWlkID0gdXVpZDtcbiAgICAgICAgY29uc3QgaWNvbjogYW55ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndWktaWNvbicpO1xuICAgICAgICBkaXYuYXBwZW5kQ2hpbGQoaWNvbik7XG4gICAgICAgIGlmICh1cmwuZW5kc1dpdGgoJy5zY2VuZScpKSB7XG4gICAgICAgICAgICBpY29uLnZhbHVlID0gJ3NjZW5lJztcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmICh1cmwuZW5kc1dpdGgoJy5wcmVmYWInKSkge1xuICAgICAgICAgICAgaWNvbi52YWx1ZSA9ICdwcmVmYWInO1xuICAgICAgICB9XG4gICAgICAgIGljb24uc2V0QXR0cmlidXRlKCdjb2xvcicsICcjZjBhZDRlJyk7XG4gICAgICAgIGNvbnN0IGxhYmVsOiBhbnkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd1aS1sYWJlbCcpO1xuICAgICAgICBsYWJlbC52YWx1ZSA9IGJhc2VuYW1lKHVybCk7XG4gICAgICAgIGRpdi5hcHBlbmRDaGlsZChsYWJlbCk7XG4gICAgICAgIGNvbnN0IGljb25fZGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndWktaWNvbicpO1xuICAgICAgICBpY29uX2RlbC5zZXRBdHRyaWJ1dGUoJ3ZhbHVlJywgJ2RlbCcpO1xuICAgICAgICBpY29uX2RlbC5jbGFzc05hbWUgPSAnZGVsJztcbiAgICAgICAgZGl2LmFwcGVuZENoaWxkKGljb25fZGVsKTtcbiAgICAgICAgaWYgKHRoaXMuJGNvbnRlbnQpIHtcbiAgICAgICAgICAgIHRoaXMuJGNvbnRlbnQuaW5zZXJ0QmVmb3JlKGRpdiwgdGhpcy4kY29udGVudC5maXJzdENoaWxkKTtcbiAgICAgICAgfVxuICAgICAgICBpY29uX2RlbC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMuX29uRGVsLmJpbmQodGhpcywgZGl2KSk7XG4gICAgICAgIGRpdi5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCB0aGlzLl9vbk1vdXNlRG93bi5iaW5kKHRoaXMpKTtcbiAgICAgICAgdGhpcy5fbGlzdC5zZXQodXVpZCwgbGFiZWwpO1xuICAgICAgICByZXR1cm4gZGl2O1xuICAgIH1cblxuICAgIGFzeW5jIG9uU2NlbmVSZWFkeSh1dWlkOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKHRoaXMuX25vQ2hhbmdlKSB7XG4gICAgICAgICAgICB0aGlzLl9ub0NoYW5nZSA9IGZhbHNlO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGxldCBsaXN0OiBzdHJpbmdbXSA9IGF3YWl0IEVkaXRvci5Qcm9maWxlLmdldENvbmZpZygnc2NlbmUtcmVjb3JkJywgJ2xpc3QnKSB8fCBbXTtcbiAgICAgICAgY29uc3QgaW5kZXggPSBsaXN0LmluZGV4T2YodXVpZCk7XG4gICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHtcbiAgICAgICAgICAgIGxpc3Quc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgICAgIGNvbnN0IGxhYmVsID0gdGhpcy5fbGlzdC5nZXQodXVpZCk7XG4gICAgICAgICAgICBpZiAodGhpcy4kY29udGVudCAmJiBsYWJlbCAmJiBsYWJlbC5wYXJlbnRFbGVtZW50KSB7XG4gICAgICAgICAgICAgICAgdGhpcy4kY29udGVudC5yZW1vdmVDaGlsZChsYWJlbC5wYXJlbnRFbGVtZW50KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBsaXN0LnB1c2godXVpZCk7XG4gICAgICAgIGNvbnN0IGl0ZW0gPSBhd2FpdCB0aGlzLmFkZEl0ZW0odXVpZCk7XG4gICAgICAgIGF3YWl0IEVkaXRvci5Qcm9maWxlLnNldENvbmZpZygnc2NlbmUtcmVjb3JkJywgJ2xpc3QnLCBsaXN0KTtcbiAgICAgICAgdGhpcy5jaGFuZ2VTdGF0ZShpdGVtKTtcbiAgICAgICAgdGhpcy5wYXJlbnRFbGVtZW50LnNjcm9sbFRvcCA9IDA7XG4gICAgfVxuXG4gICAgYXN5bmMgb25Bc3NldENoYW5nZSh1dWlkOiBzdHJpbmcpIHtcbiAgICAgICAgbGV0IGl0ZW06IGFueSA9IHRoaXMuX2xpc3QuZ2V0KHV1aWQpO1xuICAgICAgICBpZiAoaXRlbSkge1xuICAgICAgICAgICAgbGV0IHVybCA9IGF3YWl0IEVkaXRvci5NZXNzYWdlLnJlcXVlc3QoJ2Fzc2V0LWRiJywgJ3F1ZXJ5LXVybCcsIHV1aWQpO1xuICAgICAgICAgICAgaXRlbS52YWx1ZSA9IGJhc2VuYW1lKHVybCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBvbkFzc2V0RGJSZWFkeSgpIHtcbiAgICAgICAgYXdhaXQgdGhpcy51cGRhdGVMaXN0KCk7XG4gICAgfVxuXG4gICAgYXN5bmMgY29ubmVjdGVkQ2FsbGJhY2soKSB7XG4gICAgICAgIGF3YWl0IHRoaXMudXBkYXRlTGlzdCgpO1xuICAgICAgICBvblNjZW5lUmVhZHkgPSB0aGlzLm9uU2NlbmVSZWFkeS5iaW5kKHRoaXMpO1xuICAgICAgICBFZGl0b3IuTWVzc2FnZS5hZGRCcm9hZGNhc3RMaXN0ZW5lcihgc2NlbmU6cmVhZHlgLCBvblNjZW5lUmVhZHkpO1xuICAgICAgICBvbkFzc2V0RGJSZWFkeSA9IHRoaXMub25Bc3NldERiUmVhZHkuYmluZCh0aGlzKTtcbiAgICAgICAgRWRpdG9yLk1lc3NhZ2UuYWRkQnJvYWRjYXN0TGlzdGVuZXIoJ2Fzc2V0LWRiOnJlYWR5Jywgb25Bc3NldERiUmVhZHkpO1xuICAgICAgICBvbkFzc2V0Q2hhbmdlID0gdGhpcy5vbkFzc2V0Q2hhbmdlLmJpbmQodGhpcyk7XG4gICAgICAgIEVkaXRvci5NZXNzYWdlLmFkZEJyb2FkY2FzdExpc3RlbmVyKCdhc3NldC1kYjphc3NldC1jaGFuZ2UnLCBvbkFzc2V0Q2hhbmdlKTtcbiAgICB9XG5cbiAgICBkaXNjb25uZWN0ZWRDYWxsYmFjaygpIHtcbiAgICAgICAgRWRpdG9yLk1lc3NhZ2UucmVtb3ZlQnJvYWRjYXN0TGlzdGVuZXIoYHNjZW5lOnJlYWR5YCwgb25TY2VuZVJlYWR5KTtcbiAgICAgICAgRWRpdG9yLk1lc3NhZ2UucmVtb3ZlQnJvYWRjYXN0TGlzdGVuZXIoYHNjZW5lOnJlYWR5YCwgb25Bc3NldERiUmVhZHkpO1xuICAgICAgICBFZGl0b3IuTWVzc2FnZS5yZW1vdmVCcm9hZGNhc3RMaXN0ZW5lcignYXNzZXQtZGI6YXNzZXQtY2hhbmdlJywgb25Bc3NldENoYW5nZSk7XG4gICAgfVxuXG4gICAgYXN5bmMgX29uRGVsKGRpdjogSFRNTEVsZW1lbnQsIGV2ZW50OiBFdmVudCkge1xuICAgICAgICBpZiAodGhpcy4kY29udGVudCkge1xuICAgICAgICAgICAgdGhpcy4kY29udGVudC5yZW1vdmVDaGlsZChkaXYpO1xuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgY29uc3QgdXVpZCA9IGRpdi51dWlkO1xuICAgICAgICAgICAgdGhpcy5fbGlzdC5kZWxldGUodXVpZCk7XG4gICAgICAgICAgICBsZXQgbGlzdDogc3RyaW5nW10gPSBhd2FpdCBFZGl0b3IuUHJvZmlsZS5nZXRDb25maWcoJ3NjZW5lLXJlY29yZCcsICdsaXN0JykgfHwgW107XG4gICAgICAgICAgICBjb25zdCBpbmRleCA9IGxpc3QuaW5kZXhPZih1dWlkKTtcbiAgICAgICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHtcbiAgICAgICAgICAgICAgICBsaXN0LnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBhd2FpdCBFZGl0b3IuUHJvZmlsZS5zZXRDb25maWcoJ3NjZW5lLXJlY29yZCcsICdsaXN0JywgbGlzdCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBfb25Nb3VzZURvd24oZXZlbnQ6IEV2ZW50KSB7XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgaWYgKGV2ZW50LnRhcmdldC5jbGFzc05hbWUgPT09ICdkZWwnKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICBsZXQgZGl2OiBIVE1MRGl2RWxlbWVudCA9IGV2ZW50LnRhcmdldC5jbGFzc05hbWUgPT09ICdpdGVtJyA/IGV2ZW50LnRhcmdldCA6IGV2ZW50LnRhcmdldC5wYXJlbnRFbGVtZW50O1xuICAgICAgICBkaXYuY2xhc3NMaXN0LnRvZ2dsZSgncHJlc3MnKTtcbiAgICAgICAgY29uc3QgbW91c2VVcCA9IGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuX25vQ2hhbmdlID0gdHJ1ZTtcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgIGF3YWl0IEVkaXRvci5NZXNzYWdlLnNlbmQoJ3NjZW5lJywgJ29wZW4tc2NlbmUnLCBkaXYudXVpZCk7XG4gICAgICAgICAgICBkaXYuY2xhc3NMaXN0LnRvZ2dsZSgncHJlc3MnKTtcbiAgICAgICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBtb3VzZVVwLCB0cnVlKTtcbiAgICAgICAgICAgIHRoaXMuY2hhbmdlU3RhdGUoZGl2KTtcbiAgICAgICAgfTtcbiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIG1vdXNlVXAsIHRydWUpO1xuICAgIH1cblxuICAgIGFzeW5jIHVwZGF0ZUxpc3QoKSB7XG4gICAgICAgIGlmICh0aGlzLl9pbml0KSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5faW5pdCA9IHRydWU7XG4gICAgICAgIGNvbnN0IGxpc3QgPSBhd2FpdCBFZGl0b3IuUHJvZmlsZS5nZXRDb25maWcoJ3NjZW5lLXJlY29yZCcsICdsaXN0JykgfHwgW107XG4gICAgICAgIGZvciAobGV0IHV1aWQgb2YgbGlzdCkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5hZGRJdGVtKHV1aWQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgY2hhbmdlU3RhdGUoZGl2OiBIVE1MRWxlbWVudCkge1xuICAgICAgICBpZiAodGhpcy5fbGFzdFRhcmdldCkge1xuICAgICAgICAgICAgdGhpcy5fbGFzdFRhcmdldC5jbGFzc0xpc3QudG9nZ2xlKCdzZWxlY3QnKTtcbiAgICAgICAgfVxuICAgICAgICBkaXYuY2xhc3NMaXN0LnRvZ2dsZSgnc2VsZWN0Jyk7XG4gICAgICAgIHRoaXMuX2xhc3RUYXJnZXQgPSBkaXY7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IFNjZW5lSGlzdHJveTtcblxud2luZG93LmN1c3RvbUVsZW1lbnRzLmRlZmluZSgnc2NlbmUtcmVjb3JkLWxpc3QnLCBTY2VuZUhpc3Ryb3kpO1xuIl19